# evostitch Web Architecture

Browser-based viewer for gigapixel microscopy mosaics generated by the core pipeline.

---

## Overview

The web component is a static site that displays DZI (Deep Zoom Image) pyramids using OpenSeadragon. It consists of two pages:

1. **Catalog page** (`index.html`) - Grid of available mosaics with thumbnails
2. **Viewer page** (`viewer.html`) - Full-screen image viewer with navigation

```
User browses catalog → Clicks mosaic card → Viewer loads DZI tiles from R2
```

---

## Module Structure

```
web/
├── index.html          # Catalog page
├── viewer.html         # Viewer page (loads OpenSeadragon)
├── js/
│   ├── catalog.js      # Catalog loading and card rendering
│   └── viewer.js       # Viewer initialization, scale bar, Z-navigation
├── css/
│   └── style.css       # Shared styles (dark theme)
├── mosaics/
│   └── catalog.json    # Mosaic registry (metadata for all available mosaics)
└── CNAME               # GitHub Pages custom domain (evostitch.net)
```

---

## Key Components

### catalog.js

Loads `mosaics/catalog.json` and renders mosaic cards with thumbnails.

| Function | Purpose |
|----------|---------|
| `init()` | Fetch catalog, render cards |
| `createMosaicCard()` | Build card HTML with thumbnail, title, dimensions |
| `formatNumber()` | Format large numbers (e.g., "12.3k") |

**Data flow:**
```
Fetch catalog.json → Parse mosaic entries → Render cards → Link to viewer.html?mosaic={id}
```

### viewer.js

Initializes OpenSeadragon and handles 2D/3D viewing modes.

| Function | Purpose |
|----------|---------|
| `init()` | Load metadata, detect 2D vs 3D, initialize viewer |
| `init2D()` | Single-plane DZI viewer |
| `initZStack()` | Multi-plane viewer with Z-slider |
| `updateScaleBar()` | Adaptive scale bar based on zoom level |
| `updateCoordinates()` | Display cursor position in micrometers |
| `setZPlane()` | Switch visible Z-plane (opacity toggle) |
| `preloadAdjacentPlanes()` | Warm cache for smooth Z-navigation |
| `getDeviceConfig()` | Adaptive cache sizing based on device memory |

**Viewer modes:**

| Mode | Condition | Behavior |
|------|-----------|----------|
| 2D | `zCount == 1` | Single DZI tile source |
| 3D | `zCount > 1` | All Z-planes loaded, opacity switching |

---

## Integration with Core Pipeline

The web viewer consumes output from core's DZI generation:

```
core/                                    web/
┌────────────────────┐                  ┌────────────────────┐
│ evostitch publish  │ ──────────────→ │ R2 Cloud Storage   │
│ (generates DZI)    │   rclone        │ (DZI tiles)        │
└────────────────────┘                  └─────────┬──────────┘
                                                  │
                                        ┌─────────▼──────────┐
                                        │ viewer.js fetches  │
                                        │ metadata.json +    │
                                        │ {name}.dzi         │
                                        └────────────────────┘
```

### DZI Structure (2D)

```
{mosaic_id}/
├── metadata.json       # Width, height, scale, title
├── {name}.dzi          # DZI descriptor
└── {name}_files/       # Tile pyramid
    ├── 0/              # Lowest resolution
    ├── 1/
    └── ...             # Highest resolution
```

### DZI Structure (3D Z-stack)

```
{mosaic_id}/
├── metadata.json       # width, height, scale, zCount, zLabels, zSpacing
├── z_00/
│   ├── mosaic.dzi
│   └── mosaic_files/
├── z_01/
│   ├── mosaic.dzi
│   └── mosaic_files/
└── ...
```

---

## OpenSeadragon Configuration

Key settings in `OSD_CONFIG`:

| Setting | Value | Purpose |
|---------|-------|---------|
| `showNavigator` | true | Mini-map in corner |
| `maxZoomPixelRatio` | 2 | Allow 2x native zoom |
| `maxImageCacheCount` | 500 (base) | Tile cache size |
| `imageLoaderLimit` | 4 | Concurrent tile requests |

### Device-Adaptive Settings

Cache sizes adjust based on `navigator.deviceMemory`:

| Device Tier | Memory | Cache Base | Preload Radius |
|-------------|--------|------------|----------------|
| Mobile | < 4 GB | 150 tiles | ±1 plane |
| Standard | 4-8 GB | 200 tiles | ±2 planes |
| High | 8+ GB | 300 tiles | ±2 planes |

---

## Z-Stack Navigation

For 3D mosaics, all Z-planes are loaded into OpenSeadragon's world. Only one plane is visible at a time (opacity = 1), others are hidden (opacity = 0).

**Controls:**
- Slider: Direct plane selection
- Arrow Up/Down: Step through planes
- Shift+Scroll: Navigate Z while zooming normally
- Home/End: Jump to first/last plane

**Preloading:** Adjacent planes within `preloadRadius` have `setPreload(true)` for smoother transitions.

---

## Coordinate System

Coordinates displayed match QuPath conventions:
- Origin: top-left
- Units: micrometers (µm)
- Y increases downward

Conversion: `µm = pixel * scaleUmPerPixel`

The `metadata.json` provides scale from core's OME-TIFF metadata.

---

## Deployment

Static files deployed to GitHub Pages from `web/` directory.
- Custom domain: evostitch.net (configured via CNAME file)
- DZI tiles served from Cloudflare R2 (separate from GitHub Pages)
